name: all_packages
on:
  pull_request:
  push:
    branches:
      - master

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: "Install Flutter"
        run: ./.github/workflows/scripts/install-flutter.sh stable
      - name: "Install Tools"
        run: |
          ./.github/workflows/scripts/install-tools.sh
      - name: "Bootstrap Workspace"
        run: |
          # We need to manually pub get in melos to allow it to work first time
          # as we're using melos source to bootstrap itself 
          cd packages/melos && pub get && cd .. && cd ..
          melos bootstrap
      - uses: axel-op/dart-package-analyzer@v3
        with:
          githubToken: ${{ secrets.GH_TOKEN }}

  format:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v1
        with:
          fetch-depth: 0
      - name: "Install Flutter"
        run: ./.github/workflows/scripts/install-flutter.sh stable
      - name: "Install Tools"
        run: |
          ./.github/workflows/scripts/install-tools.sh
      - name: "Bootstrap Workspace"
        run: |
          # We need to manually pub get in melos to allow it to work first time
          # as we're using melos source to bootstrap itself 
          cd packages/melos && pub get && cd .. && cd ..
          melos bootstrap
      - name: "Dart"
        run: |
          melos run format
          ./.github/workflows/scripts/validate-formatting.sh

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v1
        with:
          fetch-depth: 0
      - name: "Install Flutter"
        run: ./.github/workflows/scripts/install-flutter.sh stable
      - name: "Install Tools"
        run: |
          ./.github/workflows/scripts/install-tools.sh
      - name: "Bootstrap Workspace"
        run: |
          # We need to manually pub get in melos to allow it to work first time
          # as we're using melos source to bootstrap itself 
          cd packages/melos && pub get && cd .. && cd ..
          melos bootstrap
      - name: "Run Tests"
        run: melos run test
